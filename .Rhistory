scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 10, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2_new, p2_Q2_new,
ncol = 2,
top = textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = gpar(fontsize = 16, fontface = "bold")
)
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 14, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 10, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2_new, p2_Q2_new,
ncol = 2,
top = textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = gpar(fontsize = 12, fontface = "bold")
)
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2_new, p2_Q2_new,
ncol = 2,
top = textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = gpar(fontsize = 16, fontface = "bold")
)
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2_new, p2_Q2_new,
ncol = 2,
top = textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = gpar(fontsize = 14, fontface = "bold")
)
)
# Core tidyverse
library(tidyverse)
library(lubridate)
# Spatial data
library(sf)
library(tigris)
# Census data
library(tidycensus)
# Weather data
library(riem)  # For Philadelphia weather from ASOS stations
# Visualization
library(viridis)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
# here!
library(here)
# Extra
library(tidytext)
# Get rid of scientific notation. We gotta look good!
options(scipen = 999)
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
message = FALSE,
cache = TRUE
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2, p2_Q2,
ncol = 2,
top = grid::textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = grid::gpar(fontsize = 14, fontface = "bold")
)
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2, p2_Q2,
ncol = 2,
top = grid::textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = grid::gpar(fontsize = 14, fontface = "bold")
)
)
## Spatial Error Patterns – New Model 2
# MAE by station (Q2, Model 2 with new features)
station_errors_Q2_new <- test_Q2 %>%
filter(!is.na(pred2_new_Q2)) %>%
group_by(start_station, start_lat.x, start_lon.x) %>%
summarize(
MAE        = mean(abs_error_new, na.rm = TRUE),
avg_demand = mean(Trip_Count,    na.rm = TRUE),
.groups    = "drop"
) %>%
filter(!is.na(start_lat.x), !is.na(start_lon.x))
# Map 1: Prediction errors (new model)
p1_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = MAE),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "plasma",
name   = "MAE (trips)",
direction = -1
) +
labs(
title    = "Prediction Errors – Q2 2025",
subtitle = "Station-level MAE with engineered features"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Map 2: Average demand (same, just reusing the new MAE table)
p2_Q2_new <- ggplot() +
geom_sf(data = philly_census, fill = "grey95", color = "white", size = 0.2) +
geom_point(
data = station_errors_Q2_new,
aes(x = start_lon.x, y = start_lat.x, color = avg_demand),
size = 3.5,
alpha = 0.7
) +
scale_color_viridis(
option = "viridis",
name   = "Avg Demand\n(trips/hour)",
direction = -1
) +
labs(
title    = "Average Demand – Q2 2025",
subtitle = "Mean trips per station-hour"
) +
mapTheme +
theme(
legend.position = "right",
legend.title    = element_text(size = 10, face = "bold"),
legend.text     = element_text(size = 9),
plot.title      = element_text(size = 14, face = "bold"),
plot.subtitle   = element_text(size = 10)
)
# Side-by-side layout
grid.arrange(
p1_Q2_new, p2_Q2_new,
ncol = 2,
top = grid::textGrob(
"New Model 2 Performance in Q2: Prediction Errors vs Average Demand",
gp = grid::gpar(fontsize = 14, fontface = "bold")
)
)
