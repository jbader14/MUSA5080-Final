[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "MUSA 5080 Final Project",
    "section": "",
    "text": "Project Overview:\n\nMembers: Jack Bader, Joey Cahill, Sam Sen,\nDate: December 8th, 2025"
  },
  {
    "objectID": "appendix/appendix.html",
    "href": "appendix/appendix.html",
    "title": "Technical Appendix",
    "section": "",
    "text": "Code\n# Core tidyverse\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(lubridate)\n\n# Spatial data\nlibrary(sf)\nlibrary(tigris)\n\n# Census data\nlibrary(tidycensus)\n\n# Weather data\nlibrary(riem)  # For Philadelphia weather from ASOS stations\n\n# Visualization\nlibrary(viridis)\nlibrary(grid)\nlibrary(gridExtra)\nlibrary(knitr)\nlibrary(kableExtra)\n\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(patchwork)\n\n# here!\nlibrary(here)\n\n# Extra\nlibrary(tidytext)\nlibrary(MASS)\n\n# Get rid of scientific notation. We gotta look good!\noptions(scipen = 999)\n\n\n\n\n\n\n\nCode\nkey &lt;- Sys.getenv(\"CENSUS_API_KEY\")\ncensus_api_key(key)"
  },
  {
    "objectID": "appendix/appendix.html#load-libraries",
    "href": "appendix/appendix.html#load-libraries",
    "title": "Technical Appendix",
    "section": "",
    "text": "Code\n# Core tidyverse\nlibrary(tidyverse)\nlibrary(janitor)\nlibrary(lubridate)\n\n# Spatial data\nlibrary(sf)\nlibrary(tigris)\n\n# Census data\nlibrary(tidycensus)\n\n# Weather data\nlibrary(riem)  # For Philadelphia weather from ASOS stations\n\n# Visualization\nlibrary(viridis)\nlibrary(grid)\nlibrary(gridExtra)\nlibrary(knitr)\nlibrary(kableExtra)\n\nlibrary(ggplot2)\nlibrary(scales)\nlibrary(patchwork)\n\n# here!\nlibrary(here)\n\n# Extra\nlibrary(tidytext)\nlibrary(MASS)\n\n# Get rid of scientific notation. We gotta look good!\noptions(scipen = 999)"
  },
  {
    "objectID": "appendix/appendix.html#define-themes",
    "href": "appendix/appendix.html#define-themes",
    "title": "Technical Appendix",
    "section": "",
    "text": "Code\nplotTheme &lt;- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  plot.subtitle = element_text(size = 10),\n  plot.caption = element_text(size = 8),\n  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),\n  axis.text.y = element_text(size = 10),\n  axis.title = element_text(size = 11, face = \"bold\"),\n  panel.background = element_blank(),\n  panel.grid.major = element_line(colour = \"#D0D0D0\", size = 0.2),\n  panel.grid.minor = element_blank(),\n  axis.ticks = element_blank(),\n  legend.position = \"right\"\n)\n\nmapTheme &lt;- theme(\n  plot.title = element_text(size = 14, face = \"bold\"),\n  plot.subtitle = element_text(size = 10),\n  plot.caption = element_text(size = 8),\n  axis.line = element_blank(),\n  axis.text = element_blank(),\n  axis.ticks = element_blank(),\n  axis.title = element_blank(),\n  panel.background = element_blank(),\n  panel.border = element_blank(),\n  panel.grid.major = element_line(colour = 'transparent'),\n  panel.grid.minor = element_blank(),\n  legend.position = \"right\",\n  plot.margin = margin(1, 1, 1, 1, 'cm'),\n  legend.key.height = unit(1, \"cm\"),\n  legend.key.width = unit(0.2, \"cm\")\n)\n\npalette5 &lt;- c(\"#eff3ff\", \"#bdd7e7\", \"#6baed6\", \"#3182bd\", \"#08519c\")"
  },
  {
    "objectID": "appendix/appendix.html#set-census-api-key",
    "href": "appendix/appendix.html#set-census-api-key",
    "title": "Technical Appendix",
    "section": "",
    "text": "Code\nkey &lt;- Sys.getenv(\"CENSUS_API_KEY\")\ncensus_api_key(key)"
  },
  {
    "objectID": "appendix/appendix.html#monthly-average-daily-ridership-by-transit-mode",
    "href": "appendix/appendix.html#monthly-average-daily-ridership-by-transit-mode",
    "title": "Technical Appendix",
    "section": "Monthly Average Daily Ridership by Transit Mode",
    "text": "Monthly Average Daily Ridership by Transit Mode\n\n\nCode\n# Engineer a date feature for plotting\ntransit_mode_monthly &lt;- transit_mode |&gt;\n  mutate(\n    date = ymd(paste(Calendar_Year, Calendar_Month, \"01\", sep = \"-\"))\n  )\n\n# Plot line chart with a line for each transit mode over time\nggplot(transit_mode_monthly,\n       aes(x = date,\n           y = Average_Daily_Ridership,\n           color = Mode)) +\n  geom_line(linewidth = 1) +\n  labs(\n    title = \"Monthly Average Daily Ridership by Transit Mode\",\n    subtitle = \"SEPTA in Philadelphia from 2019 - 2025\",\n    x = \"Date\",\n    y = \"Average Daily Ridership\",\n    color = \"Transit Mode\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "appendix/appendix.html#total-bus-ridership-by-day-of-week-philadelphia-census-tracts",
    "href": "appendix/appendix.html#total-bus-ridership-by-day-of-week-philadelphia-census-tracts",
    "title": "Technical Appendix",
    "section": "Total Bus Ridership by Day of Week, Philadelphia Census Tracts",
    "text": "Total Bus Ridership by Day of Week, Philadelphia Census Tracts\n\n\nCode\n# Filter to Philadelphia County and clean fields\nbus_tract_phila &lt;- bus_tract %&gt;%\n  filter(County_Name == \"Philadelphia County\") %&gt;%\n  mutate(\n    year = as.integer(stringr::str_extract(Season, \"\\\\d{4}\")),\n    total_ridership = On_ + Off_\n  )\n\n# Aggregate to total ridership by year and day-of-week\nbus_tract_year_dow &lt;- bus_tract_phila %&gt;%\n  group_by(year, Day_of_Week) %&gt;%\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\n# Minimal line plot of total ridership over time by day-of-week\nggplot(bus_tract_year_dow,\n       aes(x = year, y = total_ridership, color = Day_of_Week)) +\n  geom_line(linewidth = 0.9) +\n  geom_point(size = 1.8) +\n  labs(\n    title = \"Total SEPTA Bus Ridership by Day of Week\",\n    subtitle = \"Average daily boardings + departures for Fall only\",\n    x = \"Year\",\n    y = \"Total Average Daily Ridership\",\n    color = \"Day of Week\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "appendix/appendix.html#total-septa-bus-ridership-by-day-of-week",
    "href": "appendix/appendix.html#total-septa-bus-ridership-by-day-of-week",
    "title": "Technical Appendix",
    "section": "Total SEPTA Bus Ridership by Day of Week",
    "text": "Total SEPTA Bus Ridership by Day of Week\n\n\nCode\n# Aggregate to total ridership by year and day-of-week\nbus_tract_year_dow &lt;- bus_tract_phila |&gt;\n  group_by(year, Day_of_Week) |&gt;\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\n# Minimal line plot of total ridership over time by day-of-week\nggplot(bus_tract_year_dow,\n       aes(x = year, y = total_ridership, color = Day_of_Week)) +\n  geom_line(linewidth = 0.9) +\n  geom_point(size = 1.8) +\n  labs(\n    title = \"Total SEPTA Bus Ridership by Day of Week\",\n    subtitle = \"Average daily boardings + departures for Fall only\",\n    x = \"Year\",\n    y = \"Total Average Daily Ridership\",\n    color = \"Day of Week\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "appendix/appendix.html#pre-vs.-post-covid-ridership-comparison",
    "href": "appendix/appendix.html#pre-vs.-post-covid-ridership-comparison",
    "title": "Technical Appendix",
    "section": "Pre vs. Post COVID Ridership Comparison",
    "text": "Pre vs. Post COVID Ridership Comparison\n\n\nCode\n# Aggregate to one row per tract-year\ntract_19_21 &lt;- bus_tract_phila |&gt;\n  filter(\n    year %in% c(2019, 2021)\n  ) |&gt;\n  group_by(Census_Tract_ID, year) |&gt;\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  ) |&gt;\n  # Pivot to wide format for plotting\n  pivot_wider(\n    names_from = year,\n    values_from = total_ridership,\n    names_prefix = \"y\"\n  ) |&gt;\n  # Drop tracts with missing data\n  tidyr::drop_na(y2019, y2021)\n\n# Plot 2019 vs 2021 ridership scatterplot\nggplot(tract_19_21,\n       aes(x = y2019, y = y2021)) +\n  geom_point(alpha = 0.6) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dashed\") +\n  labs(\n    title = \"Tract-Level Weekday Ridership: 2019 vs 2021\",\n    subtitle = \"Each point represents a census tract in Philadelphia County\",\n    x = \"2019 Ridership\",\n    y = \"2021 Ridership\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "appendix/appendix.html#tract-level-total-ridership-fall-2023",
    "href": "appendix/appendix.html#tract-level-total-ridership-fall-2023",
    "title": "Technical Appendix",
    "section": "Tract-Level Total Ridership (Fall 2023)",
    "text": "Tract-Level Total Ridership (Fall 2023)\n\n\nCode\n# Tract-level total ridership, Fall 2023\ntract_2023 &lt;- bus_tract_phila |&gt;\n  filter(year == 2023) |&gt;\n  group_by(Census_Tract_ID) |&gt;\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  ) |&gt;\n  filter(!is.na(total_ridership), total_ridership &gt; 0) |&gt;\n  # Quintiles to view meaningful patterns in plot\n  mutate(\n    ridership_q = cut_number(\n      total_ridership,\n      n = 5,\n      labels = c(\"Lowest 20%\", \"20–40%\", \"40–60%\", \"60–80%\", \"Top 20%\")\n    )\n  )\n\n# Join to tract geometries\ntract_map_2023 &lt;- tracts_sf |&gt;\n  mutate(GEOID = as.character(GEOID)) |&gt;\n  left_join(tract_2023, by = c(\"GEOID\" = \"Census_Tract_ID\"))\n\n# Plot quintiles of total ridership\nggplot(tract_map_2023) +\n  geom_sf(aes(fill = ridership_q), color = NA) +\n  scale_fill_brewer(\n    palette = \"YlGnBu\",\n    na.value = \"grey90\",\n    name = \"Quintile of\\nWeekday Ridership\"\n  ) +\n  labs(\n    title = \"Bus Ridership by Census Tract (Fall 2023)\",\n    subtitle = \"Tracts grouped into quintiles by total weekday boardings + deepartures\",\n  ) +\n  theme_minimal() +\n  theme(\n  axis.text = element_blank(),\n  axis.ticks = element_blank()\n  )"
  },
  {
    "objectID": "appendix/appendix.html#percent-change-in-tract-level-ridership-2021-2023",
    "href": "appendix/appendix.html#percent-change-in-tract-level-ridership-2021-2023",
    "title": "Technical Appendix",
    "section": "Percent Change in Tract-Level Ridership (2021-2023)",
    "text": "Percent Change in Tract-Level Ridership (2021-2023)\n\n\nCode\n# Tract-level 2019 & 2023 totals and percent change\ntract_change_21_23 &lt;- bus_tract_phila |&gt;\n  filter(\n    County_Name == \"Philadelphia County\",\n    Season %in% c(\"Fall 2021\", \"Fall 2023\"),\n    #Day_of_Week == \"Weekday\"\n  ) |&gt;\n  group_by(Census_Tract_ID, year) |&gt;\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  ) |&gt;\n  tidyr::pivot_wider(\n    names_from = year,\n    values_from = total_ridership,\n    names_prefix = \"y\"\n  ) |&gt;\n  # Needs data from both 2021 and 2023\n  filter(!is.na(y2021), !is.na(y2023), y2021 &gt; 0) |&gt;\n  mutate(\n    pct_change_21_23 = 100 * (y2023 - y2021) / y2021\n  )\n\n# Bracket into percentage bins for plotting\nbreaks &lt;- c(-Inf, -50, -25, -10, 10, 25, 50, Inf)\nlabels &lt;- c(\"≤ -50%\", \"-50% to -25%\", \"-25% to -10%\",\n            \"-10% to +10%\", \"+10% to +25%\", \"+25% to +50%\", \"≥ +50%\")\n\ntract_change_21_23 &lt;- tract_change_21_23 |&gt;\n  mutate(\n    pct_change_cat = cut(\n      pct_change_21_23,\n      breaks = breaks,\n      labels = labels,\n      include.lowest = TRUE,\n      ordered_result = TRUE\n    )\n  )\n\n# Join to tract geometries\ntract_map_change_21_23 &lt;- tracts_sf |&gt;\n  mutate(GEOID = as.character(GEOID)) |&gt;\n  left_join(tract_change_21_23, by = c(\"GEOID\" = \"Census_Tract_ID\"))\n\n# Plot map\nggplot(tract_map_change_21_23) +\n  geom_sf(aes(fill = pct_change_cat), color = NA) +\n  scale_fill_brewer(\n    palette = \"RdYlGn\",\n    na.value = \"grey90\",\n    name = \"% change\\n2021–2023\"\n  ) +\n  labs(\n    title = \"Percent Change in Bus Ridership by Census Tract\",\n    subtitle = \"From Fall 2021 - 2023; red = loss, green = gain\",\n    caption = \"Measures Post-COVID Recovery in SEPTA Usage\"\n  ) +\n  theme_minimal() +\n  theme(\n  axis.text = element_blank(),\n  axis.ticks = element_blank()\n  )"
  },
  {
    "objectID": "appendix/appendix.html#fishnet-grid-ridership-bus-stops",
    "href": "appendix/appendix.html#fishnet-grid-ridership-bus-stops",
    "title": "Technical Appendix",
    "section": "Fishnet Grid: Ridership + Bus Stops",
    "text": "Fishnet Grid: Ridership + Bus Stops\n\n\nCode\n# Aggregate total ridership across all day types\nbus_stops_2023 &lt;- bus_stops_clean |&gt;\n  filter(Sign_Up == \"Fall 2023\", Mode == \"Bus\") |&gt;\n  mutate(\n    total_all_days =\n      weekday_on  + weekday_off +\n      saturday_on + saturday_off +\n      sunday_on   + sunday_off\n  )\n\nstops_sf &lt;- st_as_sf(bus_stops_2023,\n                     coords = c(\"Lon\", \"Lat\"),\n                     crs = 4326) |&gt;\n  st_transform(26918)\n\n# Philly boundary from tracts\nphilly_boundary &lt;- tracts_sf |&gt;\n  st_transform(26918) |&gt;\n  st_union()\n\n# Construct fishnet grid\nfishnet &lt;- st_make_grid(\n  philly_boundary,\n  cellsize = 500, # 500 m x 500 m\n  square = TRUE\n) |&gt;\n  st_sf() |&gt;\n  mutate(grid_id = row_number())\n\n# Keep only cells within Philadelphia census boundaries\nfishnet &lt;- fishnet[philly_boundary, ]\n\n# Aggregate bus stops to grid cells\nstops_joined &lt;- st_join(stops_sf, fishnet, join = st_within)\n\nfishnet_agg &lt;- stops_joined |&gt;\n  st_drop_geometry() |&gt;\n  group_by(grid_id) |&gt;\n  summarise(\n    countStops      = n(),\n    totalAllDayRid  = sum(total_all_days, na.rm = TRUE),\n    .groups = \"drop\"\n  ) |&gt;\n  right_join(fishnet, by = \"grid_id\") |&gt;\n  st_as_sf()\n\n# Fishnet EDA plots (all day-types)\np_rid &lt;- ggplot() +\n  geom_sf(data = fishnet_agg, aes(fill = totalAllDayRid), color = NA) +\n  geom_sf(data = philly_boundary, fill = NA, color = \"white\", linewidth = 0.4) +\n  scale_fill_viridis_c(\n    name = \"Ridership (all days)\",\n    trans = \"sqrt\"\n  ) +\n  labs(\n    title = \"Bus Ridership by Fishnet Grid Cell\",\n    subtitle = \"500m grid, Fall 2023\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    axis.title = element_blank()\n  )\n\np_stops &lt;- ggplot() +\n  geom_sf(data = fishnet_agg, aes(fill = countStops), color = NA) +\n  geom_sf(data = philly_boundary, fill = NA, color = \"white\", linewidth = 0.4) +\n  scale_fill_viridis_c(\n    name = \"Bus stops\",\n    trans = \"sqrt\"\n  ) +\n  labs(\n    title = \"Bus Stop Counts by Fishnet Grid Cell\",\n    subtitle = \"500m x 500m grid, Fall 2023\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text  = element_blank(),\n    axis.ticks = element_blank(),\n    axis.title = element_blank()\n  )\n\np_rid + p_stops"
  },
  {
    "objectID": "appendix/appendix.html#prepare-tract-level-data",
    "href": "appendix/appendix.html#prepare-tract-level-data",
    "title": "Technical Appendix",
    "section": "Prepare Tract-Level Data",
    "text": "Prepare Tract-Level Data\n\n\nCode\nbus_tract_year &lt;- bus_tract_clean |&gt;\n  filter(Day_of_Week == \"Weekday\") |&gt;\n  group_by(Census_Tract_ID, Census_Tract_Name, year) |&gt;\n  summarise(\n    total_ridership = sum(total_ridership, na.rm = TRUE),\n    .groups = \"drop\"\n  ) |&gt;\n  arrange(Census_Tract_ID, year) |&gt;\n  group_by(Census_Tract_ID) |&gt;\n  mutate(\n    trend = year - min(year, na.rm = TRUE), # Fill in for year FE\n    post_covid = if_else(year &gt;= 2021, 1L, 0L)\n  ) |&gt;\n  ungroup() |&gt;\n  filter(total_ridership &gt; 0)"
  },
  {
    "objectID": "appendix/appendix.html#temporal-traintest-split",
    "href": "appendix/appendix.html#temporal-traintest-split",
    "title": "Technical Appendix",
    "section": "Temporal Train/Test Split",
    "text": "Temporal Train/Test Split\n\n\nCode\n# TRAIN = pre-COVID + two recovery year (2017-19, 2021-2022)\ntract_train &lt;- bus_tract_year |&gt;\n  filter(year != 2023)\n\n# TEST = heldout, evaluation year (2023)\ntract_test &lt;- bus_tract_year |&gt;\n  filter(year == 2023)"
  },
  {
    "objectID": "appendix/appendix.html#mean-absolute-error-mae-function",
    "href": "appendix/appendix.html#mean-absolute-error-mae-function",
    "title": "Technical Appendix",
    "section": "Mean Absolute Error (MAE) Function",
    "text": "Mean Absolute Error (MAE) Function\n\n\nCode\nmae &lt;- function(obs, pred) mean(abs(obs - pred))"
  },
  {
    "objectID": "appendix/appendix.html#baseline-model-1-trend-post_covid-tract-fe",
    "href": "appendix/appendix.html#baseline-model-1-trend-post_covid-tract-fe",
    "title": "Technical Appendix",
    "section": "Baseline Model 1: Trend + Post_Covid + Tract FE",
    "text": "Baseline Model 1: Trend + Post_Covid + Tract FE\n\nPoisson Model\n\n\nCode\n# Train Poisson model\nm1_pois &lt;- glm(\n  total_ridership ~ trend + post_covid + factor(Census_Tract_ID),\n  data = tract_train,\n  family = \"poisson\"\n)\n\n# Predict on test set (2023)\ntract_test &lt;- tract_test |&gt;\n  mutate(pred_m1_pois = predict(m1_pois, newdata = tract_test, type = \"response\"))\n\n# Calculate MAE\nmae_m1_pois &lt;- mae(tract_test$total_ridership, tract_test$pred_m1_pois)\nmae_m1_pois\n\n\n[1] 309.3439\n\n\n\n\nCheck For Overispersion\n\n\nCode\n# Calculate dispersion parameter\ndispersion &lt;- sum(residuals(m1_pois, type = \"pearson\")^2) / \n              m1_pois$df.residual\n\ncat(\"Dispersion parameter:\", round(dispersion, 2), \"\\n\")\n\n\nDispersion parameter: 87.34 \n\n\nCode\ncat(\"Rule of thumb: &gt;1.5 suggests overdispersion\\n\")\n\n\nRule of thumb: &gt;1.5 suggests overdispersion\n\n\nCode\nif (dispersion &gt; 1.5) {\n  cat(\"⚠ Overdispersion detected! Consider Negative Binomial model.\\n\")\n} else {\n  cat(\"✓ Dispersion looks okay for Poisson model.\\n\")\n}\n\n\n⚠ Overdispersion detected! Consider Negative Binomial model.\n\n\n\n\nTransition to Negative Binomial Model\n\n\nCode\n# Train Negative Binomial model\nm1 &lt;- glm.nb(\n  total_ridership ~ trend + post_covid + factor(Census_Tract_ID),\n  data = tract_train\n)\n\n# Predict on test set (2023)\ntract_test &lt;- tract_test |&gt;\n  mutate(pred_m1 = predict(m1, newdata = tract_test, type = \"response\"))\n\n# Calculate MAE\nmae_m1 &lt;- mae(tract_test$total_ridership, tract_test$pred_m1)\nmae_m1\n\n\n[1] 237.7002"
  },
  {
    "objectID": "appendix/appendix.html#model-2-bus-stop-density-distance-to-nearest-railtrolley-stop",
    "href": "appendix/appendix.html#model-2-bus-stop-density-distance-to-nearest-railtrolley-stop",
    "title": "Technical Appendix",
    "section": "Model 2: + Bus Stop Density, Distance to Nearest Rail/Trolley Stop",
    "text": "Model 2: + Bus Stop Density, Distance to Nearest Rail/Trolley Stop\n\nFeature Engineering: Bus Stop Densities\n\n\nCode\n# Census Tract Area (in squared km)\ntracts_sf_utm &lt;- tracts_sf |&gt;\n  st_transform(26918) |&gt;\n  mutate(\n    Census_Tract_ID = as.character(GEOID),\n    area_km2 = as.numeric(st_area(geometry)) / 1e6\n  )\n\n# Transform bus_stops_clean into a sf\nstops_sf_all &lt;- bus_stops_clean |&gt;\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326) |&gt;\n  st_transform(26918)\n\n# Spatial join: tracts to stops\nstops_with_tract &lt;- st_join(\n  stops_sf_all,\n  tracts_sf_utm |&gt; dplyr::select(Census_Tract_ID),\n  join = st_within\n) |&gt;\n  st_drop_geometry()# Transform back to tibble\n\n\n\n\nCode\n# Aggregate number of bus stops for each tract/year combo\nstops_tract_year &lt;- stops_with_tract |&gt;\n  filter(!is.na(Census_Tract_ID)) |&gt;\n  group_by(Census_Tract_ID, year) |&gt;\n  summarise(\n    n_stops = n(),\n    .groups = \"drop\"\n  )\n\n\n\n\nCode\n# Engineer bus stop + total rider density for each tract\nstops_tract_year &lt;- stops_tract_year |&gt;\n  # Join in tract area\n  left_join(\n    tracts_sf_utm |&gt; st_drop_geometry() |&gt;\n      dplyr::select(Census_Tract_ID, area_km2),\n    by = \"Census_Tract_ID\"\n  ) |&gt;\n  mutate(\n    stop_density = n_stops / area_km2\n  )\n\n# Join to tract-weekday panel\nbus_tract_year &lt;- bus_tract_year |&gt;\n  left_join(\n    stops_tract_year,\n    by = c(\"Census_Tract_ID\", \"year\")\n  )\n\n\n\n\nFeature Engineering: Distance to Nearest Rail/Trolley Stop\n\n\nCode\n# Extract only rail + trolley stations from all_stops\nrail_trolley_stations &lt;- all_stops |&gt;\n  filter(\n    LineAbbr %in% c(\"BSL\", \"MFL\", \"HRS\") | # Rail Line\n      str_starts(LineAbbr, \"T\") # Trolley\n  ) |&gt;\n  st_transform(26918)\n\n# Drop duplicate stations\nrail_trolley_stations &lt;- rail_trolley_stations |&gt;\n  group_by(StopId) |&gt;\n  summarise(geometry = st_union(geometry), .groups = \"drop\")\n\n\n\n\nCode\n# Tract centroids\ntract_centroids &lt;- tracts_sf_utm |&gt;\n  st_centroid()\n\n# Distance matrix from each tract to each station in meters\ndist_mat &lt;- st_distance(tract_centroids, rail_trolley_stations)\n\n# Nearest station distance per tract + convert to km\ndist_to_rail_km &lt;- apply(dist_mat, 1, min) / 1000\n\n# Create df with nearest distance metrics\ndist_rail_df &lt;- tracts_sf_utm |&gt;\n  st_drop_geometry() |&gt;\n  mutate(dist_to_rail_km = as.numeric(dist_to_rail_km)) |&gt;\n  dplyr::select(Census_Tract_ID, dist_to_rail_km)\n\n\n\n\nCode\n# Join to modeling df\nbus_tract_year &lt;- bus_tract_year |&gt;\n  left_join(dist_rail_df, by = \"Census_Tract_ID\")\n\n# Handle null values\nbus_tract_year &lt;- bus_tract_year |&gt;\n  mutate(\n    stop_density = tidyr::replace_na(stop_density, 0),\n  )\n\n# Train data\ntract_train_M2 &lt;- bus_tract_year |&gt;\n  filter(year %in% c(2017, 2018, 2019, 2021, 2022))\n\n# Test data\ntract_test_M2 &lt;- bus_tract_year |&gt;\n  filter(year == 2023)\n\n\n\n\nModeling\n\n\nCode\nm2 &lt;- glm.nb(\n  total_ridership ~ trend + post_covid + factor(Census_Tract_ID) + stop_density + dist_to_rail_km,\n  data = tract_train_M2\n)\n\ntract_test_M2 &lt;- tract_test_M2 |&gt;\n  mutate(pred_m2 = predict(m2, newdata = tract_test_M2, type = \"response\"))\n\nmae_m2 &lt;- mae(tract_test_M2$total_ridership, tract_test_M2$pred_m2)\nmae_m2\n\n\n[1] 277.1298"
  }
]